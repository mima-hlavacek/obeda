<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ó běda!</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css" />
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
  <style>
    .pos { color: #2e7d32; }
    .neg { color: #c62828; }
    #error { white-space: pre-wrap; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
  <script>

    const FIREBASE_CONFIG = {
      apiKey: '$SETTLEUP_API_KEY',
      authDomain: 'settle-up-live.firebaseapp.com',
      projectId: 'settle-up-live'
    };
    const RTDB_BASE = 'https://settle-up-live.firebaseio.com';
    let GROUP_ID = '-LtdrPcCEM-OCaeboJod';

    {
      const qp = new URLSearchParams(window.location.search);
      const g = qp.get('group');
      if (g) GROUP_ID = g;
    }

    const $ = (id) => document.getElementById(id);
    let auth, user, currencyCode = '';
    let userGroups = [];

    function fmtAmount(value) {
      const digits = 2;
      try {
        return new Intl.NumberFormat(undefined, { style: currencyCode ? 'currency' : 'decimal', currency: currencyCode || undefined, maximumFractionDigits: digits, minimumFractionDigits: digits }).format(value);
      } catch (_) {
        return (currencyCode ? currencyCode + ' ' : '') + value.toFixed(digits);
      }
    }

    async function getIdToken() {
      if (!auth || !auth.currentUser) return null;
      try { return await auth.currentUser.getIdToken(false); } catch { return null; }
    }

    async function fetchRTDB(path) {
      const token = await getIdToken();
      if (!token) throw new Error('Not signed in');
      const url = `${RTDB_BASE}/${path}.json?auth=${encodeURIComponent(token)}`;
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? '\n' + txt : ''}`);
      }
      return res.json();
    }

    async function loadUserGroups() {
      if (!user) return [];
      const ug = await fetchRTDB(`userGroups/${user.uid}`);
      const entries = Object.entries(ug || {}).map(([id, v]) => ({ id, order: (v && typeof v.order === 'number') ? v.order : Number.MAX_SAFE_INTEGER, color: v && v.color || undefined }));
      const withNames = await Promise.all(entries.map(async (e) => {
        try {
          const g = await fetchRTDB(`groups/${e.id}`);
          return { ...e, name: (g && g.name) ? String(g.name) : e.id };
        } catch {
          return { ...e, name: e.id };
        }
      }));
      withNames.sort((a, b) => (a.order - b.order) || String(a.name).localeCompare(String(b.name)));
      return withNames;
    }

    function populateGroupSelect(groups) {
      const sel = $('groupSelect');
      sel.innerHTML = '';
      for (const g of groups) {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name || g.id;
        sel.appendChild(opt);
      }
      sel.disabled = groups.length === 0 || !user;
    }

    function updateUrlGroup(groupId) {
      const url = new URL(window.location.href);
      if (groupId) url.searchParams.set('group', groupId); else url.searchParams.delete('group');
      window.history.replaceState({}, '', url);
    }

    function aggregate(debts, members) {
      const map = new Map(); // id -> balance
      const nameById = new Map(Object.entries(members || {}).map(([id, m]) => [id, (m && m.name) ? String(m.name) : id]));

      const arr = Array.isArray(debts) ? debts : debts && typeof debts === 'object' ? Object.values(debts) : [];
      for (const d of arr) {
        if (!d) continue;
        const fromId = d.from;
        const toId = d.to;
        const amount = Number(d.amount ?? 0) || 0;
        if (fromId == null || toId == null) continue;
        const f = String(fromId), t = String(toId);
        map.set(f, (map.get(f) || 0) - amount);
        map.set(t, (map.get(t) || 0) + amount);
      }

      if (members && typeof members === 'object') {
        for (const id of Object.keys(members)) {
          if (!map.has(id)) map.set(id, 0);
        }
      }

      const rows = [];
      for (const [id, bal] of map.entries()) {
        rows.push({ id, name: nameById.get(id) || id, balance: bal });
      }
      rows.sort((a, b) => a.balance - b.balance); // most owed first
      return rows;
    }

    async function refresh() {
      $('error').textContent = '';
      $('tbody').innerHTML = '';
      try {
        const [group, members, debts] = await Promise.all([
          fetchRTDB(`groups/${GROUP_ID}`),
          fetchRTDB(`members/${GROUP_ID}`),
          fetchRTDB(`debts/${GROUP_ID}`)
        ]);

        currencyCode = group && group.convertedToCurrency ? String(group.convertedToCurrency) : '';

        const rows = aggregate(debts, members);

        let total = 0;
        for (const r of rows) total += r.balance;

        for (const r of rows) {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdBal = document.createElement('td');
          tdName.textContent = r.name;
          tdBal.textContent = fmtAmount(r.balance);
          tdBal.className = r.balance < 0 ? 'neg' : (r.balance > 0 ? 'pos' : '');
          tr.appendChild(tdName);
          tr.appendChild(tdBal);
          $('tbody').appendChild(tr);
        }

        $('meta').textContent = `Users: ${rows.length} • Net check: ${fmtAmount(total)} • Updated ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        $('error').textContent = String(e?.message || e);
      }
    }

    function setAuthUi() {
      $('userEmail').textContent = user ? (user.email || user.uid) : '';
      if ($('openAuthModal')) $('openAuthModal').disabled = !!user;
      $('signOut').disabled = !user;
      $('refresh').disabled = !user;
      $('groupSelect').disabled = !user || (userGroups.length === 0);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const app = firebase.initializeApp(FIREBASE_CONFIG);
      auth = firebase.auth(app);

      const uiConfig = {
        signInFlow: 'popup',
        signInOptions: [
          'google.com',
          'facebook.com',
          'apple.com',
          'password',
        ],
        callbacks: {
          signInSuccessWithAuthResult: () => false
        }
      };

      const ui = firebaseui.auth.AuthUI.getInstance() || new firebaseui.auth.AuthUI(auth);
      auth.onAuthStateChanged((u) => {
        user = u;
        (async () => {
          if (user) {
            if ($('authDialog')?.open) { try { $('authDialog').close(); } catch {} }
            try {
              userGroups = await loadUserGroups();
            } catch (e) {
              $('error').textContent = 'Failed to load groups: ' + (e?.message || e);
              userGroups = [];
            }
            populateGroupSelect(userGroups);

            const ids = new Set(userGroups.map(g => g.id));
            if (ids.has(GROUP_ID)) {
              $('groupSelect').value = GROUP_ID;
            } else if (userGroups.length > 0) {
              GROUP_ID = userGroups[0].id;
              $('groupSelect').value = GROUP_ID;
              updateUrlGroup(GROUP_ID);
            }
            setAuthUi();
            await refresh();
          } else {
            userGroups = [];
            populateGroupSelect(userGroups);
            setAuthUi();
          }
        })();
      });
      if ($('openAuthModal')) {
        $('openAuthModal').addEventListener('click', () => {
          try { $('authDialog').showModal(); } catch {}
          ui.start('#firebaseui-auth-container', uiConfig);
        });
      }
      $('signOut').addEventListener('click', async () => {
        try { await auth.signOut(); } catch (e) { $('error').textContent = 'Sign-out error: ' + e.message; }
      });
      $('refresh').addEventListener('click', refresh);
      $('groupSelect').addEventListener('change', () => {
        const gid = $('groupSelect').value;
        if (!gid || gid === GROUP_ID) return;
        GROUP_ID = gid;
        updateUrlGroup(GROUP_ID);
        refresh();
      });
    });
  </script>
</head>
<body>
  <header class="container">
    <h1>Ó běda!</h1>
    <fieldset role="group">
      <button type="button" disabled>Group</button>
      <select id="groupSelect" aria-label="Select group" disabled>
        <option value="" selected>Sign in to load groups…</option>
      </select>
    </fieldset>
    <nav>
      <ul>
        <li><button id="openAuthModal">Sign in</button></li>
        <li><button id="signOut" class="secondary" disabled>Sign out</button></li>
        <li><button id="refresh" class="contrast" disabled>Refresh</button></li>
      </ul>
    </nav>
    <dialog id="authDialog">
      <article>
        <header>
          <a href="#close" aria-label="Close" class="close"></a>
          <h3>Sign in</h3>
        </header>
        <div id="firebaseui-auth-container"></div>
      </article>
    </dialog>
    <p>User: <strong id="userEmail"></strong></p>
    <p id="error" role="alert"></p>
  </header>

  <main class="container">
    <p id="meta"></p>
    <table role="table">
      <thead>
        <tr>
          <th scope="col">Member</th>
          <th scope="col">Net balance</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>
</body>
</html>
